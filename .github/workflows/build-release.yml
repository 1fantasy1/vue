name: ğŸš€ é¸¿åº†ä¹¦äº‘ - è·¨å¹³å°æ„å»º

on:
  push:
    tags: ['v*']
  workflow_dispatch:
    inputs:
      platforms:
        description: 'é€‰æ‹©æ„å»ºå¹³å°'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - desktop-only
          - mobile-only

permissions:
  contents: write
  actions: read

env:
  NODE_VERSION: '20.x'
  APP_NAME: 'é¸¿åº†ä¹¦äº‘'

jobs:
  # Windows æ¡Œé¢åº”ç”¨æ„å»º
  build-windows:
    name: ğŸªŸ Windows æ¡Œé¢åº”ç”¨
    runs-on: windows-latest
    if: github.event.inputs.platforms != 'mobile-only'
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ è®¾ç½® Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ”§ å®‰è£…ä¾èµ–
      run: npm ci
      
    - name: ğŸ—ï¸ æ„å»º Windows åº”ç”¨
      run: npm run build:win
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: windows-installer
        path: dist-electron/*.exe
        retention-days: 7

  # Linux æ¡Œé¢åº”ç”¨æ„å»º  
  build-linux:
    name: ğŸ§ Linux æ¡Œé¢åº”ç”¨
    runs-on: ubuntu-latest
    if: github.event.inputs.platforms != 'mobile-only'
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ è®¾ç½® Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ”§ å®‰è£…ç³»ç»Ÿä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y libnss3-dev libatk-bridge2.0-dev libdrm2 libgtk-3-dev libgbm-dev
        
    - name: ğŸ”§ å®‰è£…é¡¹ç›®ä¾èµ–
      run: npm ci
      
    - name: ğŸ—ï¸ æ„å»º Linux åº”ç”¨
      run: npm run build:linux
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: linux-installer
        path: |
          dist-electron/*.AppImage
          dist-electron/*.deb
        retention-days: 7

  # Android ç§»åŠ¨åº”ç”¨æ„å»º
  build-android:
    name: ğŸ“± Android ç§»åŠ¨åº”ç”¨
    runs-on: ubuntu-latest
    if: github.event.inputs.platforms != 'desktop-only'
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ è®¾ç½® Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: â˜• è®¾ç½® Java ç¯å¢ƒ
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'
        
    - name: ğŸ”§ å®‰è£…é¡¹ç›®ä¾èµ–
      run: npm ci
      
    - name: ğŸ“± åŒæ­¥ Android é¡¹ç›®
      run: npm run cap:android
      
    - name: ğŸ—ï¸ æ„å»º Android APK
      run: |
        cd android
        chmod +x ./gradlew
        ./gradlew assembleDebug
        
    - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: android-apk
        path: android/app/build/outputs/apk/debug/*.apk
        retention-days: 7

  # åˆ›å»º GitHub Release
  create-release:
    name: ğŸ“ åˆ›å»ºå‘å¸ƒç‰ˆæœ¬
    needs: [build-windows, build-linux, build-android]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') && always()
    
    steps:
    - name: ğŸ“¥ ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        merge-multiple: true
        
    - name: ğŸ“‹ åˆ—å‡ºæ–‡ä»¶
      run: find . -type f -name "*.exe" -o -name "*.AppImage" -o -name "*.deb" -o -name "*.apk" | head -20
        
    - name: ğŸ‰ åˆ›å»º GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        name: ${{ env.APP_NAME }} ${{ github.ref_name }}
        files: |
          *.exe
          *.AppImage  
          *.deb
          *.apk
        draft: false
        prerelease: ${{ contains(github.ref_name, 'beta') || contains(github.ref_name, 'alpha') }}
        generate_release_notes: true
        body: |
          ## ğŸš€ ${{ env.APP_NAME }} ${{ github.ref_name }}
          
          ### ğŸ“¦ å®‰è£…åŒ…ä¸‹è½½
          
          **æ¡Œé¢åº”ç”¨:**
          - Windows: `*.exe` (NSIS å®‰è£…ç¨‹åº)
          - Linux: `*.AppImage` (ä¾¿æºç‰ˆ) æˆ– `*.deb` (Debian åŒ…)
          
          **ç§»åŠ¨åº”ç”¨:**
          - Android: `*.apk` (è°ƒè¯•ç‰ˆæœ¬)
          
          ### ğŸ”„ æ›´æ–°å†…å®¹
          æŸ¥çœ‹ä¸‹æ–¹è‡ªåŠ¨ç”Ÿæˆçš„æ›´æ–°æ—¥å¿—ã€‚
          
          ---
          *æœ¬ç‰ˆæœ¬é€šè¿‡ GitHub Actions è‡ªåŠ¨æ„å»ºå’Œå‘å¸ƒ*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
