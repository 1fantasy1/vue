name: 🚀 鸿庆书云 - 跨平台构建

on:
  push:
    tags: ['v*']
  workflow_dispatch:
    inputs:
      platforms:
        description: '选择构建平台'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - desktop-only
          - mobile-only

permissions:
  contents: write
  actions: read

env:
  NODE_VERSION: '20.x'
  APP_NAME: '鸿庆书云'

jobs:
  # Windows 桌面应用构建
  build-windows:
    name: 🪟 Windows 桌面应用
    runs-on: windows-latest
    if: github.event.inputs.platforms != 'mobile-only'
    
    steps:
    - name: 📥 检出代码
      uses: actions/checkout@v4
      
    - name: 📦 设置 Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: 🔧 安装依赖
      run: npm ci
      
    - name: 🏗️ 构建 Windows 应用
      run: npm run build:win
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: 📤 上传构建产物
      uses: actions/upload-artifact@v4
      with:
        name: windows-installer
        path: dist-electron/*.exe
        retention-days: 7

  # Linux 桌面应用构建  
  build-linux:
    name: 🐧 Linux 桌面应用
    runs-on: ubuntu-latest
    if: github.event.inputs.platforms != 'mobile-only'
    
    steps:
    - name: 📥 检出代码
      uses: actions/checkout@v4
      
    - name: 📦 设置 Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: 🔧 安装系统依赖
      run: |
        sudo apt-get update
        sudo apt-get install -y libnss3-dev libatk-bridge2.0-dev libdrm2 libgtk-3-dev libgbm-dev
        
    - name: 🔧 安装项目依赖
      run: npm ci
      
    - name: 🏗️ 构建 Linux 应用
      run: npm run build:linux
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: 📤 上传构建产物
      uses: actions/upload-artifact@v4
      with:
        name: linux-installer
        path: |
          dist-electron/*.AppImage
          dist-electron/*.deb
        retention-days: 7

  # Android 移动应用构建
  build-android:
    name: 📱 Android 移动应用
    runs-on: ubuntu-latest
    if: github.event.inputs.platforms != 'desktop-only'
    
    steps:
    - name: 📥 检出代码
      uses: actions/checkout@v4
      
    - name: 📦 设置 Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ☕ 设置 Java 环境
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'
        
    - name: 🔧 安装项目依赖
      run: npm ci
      
    - name: 📱 同步 Android 项目
      run: npm run cap:android
      
    - name: 🏗️ 构建 Android APK
      run: |
        cd android
        chmod +x ./gradlew
        ./gradlew assembleDebug
        
    - name: 📤 上传构建产物
      uses: actions/upload-artifact@v4
      with:
        name: android-apk
        path: android/app/build/outputs/apk/debug/*.apk
        retention-days: 7

  # 创建 GitHub Release
  create-release:
    name: 📝 创建发布版本
    needs: [build-windows, build-linux, build-android]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') && always()
    
    steps:
    - name: 📥 下载所有构建产物
      uses: actions/download-artifact@v4
      with:
        merge-multiple: true
        
    - name: 📋 列出文件
      run: find . -type f -name "*.exe" -o -name "*.AppImage" -o -name "*.deb" -o -name "*.apk" | head -20
        
    - name: 🎉 创建 GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        name: ${{ env.APP_NAME }} ${{ github.ref_name }}
        files: |
          *.exe
          *.AppImage  
          *.deb
          *.apk
        draft: false
        prerelease: ${{ contains(github.ref_name, 'beta') || contains(github.ref_name, 'alpha') }}
        generate_release_notes: true
        body: |
          ## 🚀 ${{ env.APP_NAME }} ${{ github.ref_name }}
          
          ### 📦 安装包下载
          
          **桌面应用:**
          - Windows: `*.exe` (NSIS 安装程序)
          - Linux: `*.AppImage` (便携版) 或 `*.deb` (Debian 包)
          
          **移动应用:**
          - Android: `*.apk` (调试版本)
          
          ### 🔄 更新内容
          查看下方自动生成的更新日志。
          
          ---
          *本版本通过 GitHub Actions 自动构建和发布*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
